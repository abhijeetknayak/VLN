import torch

def wrap_to_pi_torch(a: torch.Tensor) -> torch.Tensor:
    return (a + torch.pi) % (2 * torch.pi) - torch.pi


def deltas_and_trajectory_from_poses_xy(poses, pos_scale: float = 10.0, clamp: float = 2.0) -> tuple[torch.Tensor, torch.Tensor, torch.Tensor, torch.Tensor]:
    """
    Computes:
      - dyaw[t]  : (T,) yaw change from t-1 -> t (dyaw[0]=0)
      - dist[t]  : (T,) step distance in the XY plane from t-1 -> t (dist[0]=0)
      - xy[t]    : (T,2) reconstructed 2D trajectory starting at (0,0)

    Note:
      We integrate using the *previous* heading for the step:
        pos[t] = pos[t-1] + dist[t] * [cos(theta[t-1]), sin(theta[t-1])]
        theta[t] = theta[t-1] + dyaw[t]
    """
    R = poses[:, :3, :3]
    t = poses[:, :3, 3]

    assert R.dim() == 3 and R.shape[-2:] == (3, 3), f"R must be (T,3,3), got {R.shape}"
    assert t.dim() == 2 and t.shape[0] == R.shape[0], f"t must be (T,*) matching R, got {t.shape}"
    T = R.shape[0]
    device, dtype = R.device, R.dtype

    feats = torch.zeros((T, 4), device=device, dtype=dtype)  # [x_rel, y_rel, sin(theta), cos(theta)]

    # --- delta distance from translation (XY only)
    x = t[:, 0]
    y = t[:, 1]
    dist = torch.zeros((T,), device=device, dtype=dtype)
    if T > 1:
        dx = x[1:] - x[:-1]
        dy = y[1:] - y[:-1]
        dist[1:] = torch.sqrt(dx * dx + dy * dy)

    # --- delta yaw from relative rotation
    dyaw = torch.zeros((T,), device=device, dtype=dtype)
    if T > 1:
        R_rel = R[:-1].transpose(-1, -2) @ R[1:]  # (T-1,3,3)
        dyaw[1:] = -torch.atan2(R_rel[:, 1, 0], R_rel[:, 0, 0])  # yaw about Z
        dyaw = wrap_to_pi_torch(dyaw)

    # --- integrate to get 2D trajectory
    xy = torch.zeros((T, 2), device=device, dtype=dtype)
    theta = torch.zeros((T,), device=device, dtype=dtype)

    for i in range(1, T):
        # move along previous heading
        xy[i, 0] = xy[i - 1, 0] + dist[i] * torch.cos(theta[i - 1])
        xy[i, 1] = xy[i - 1, 1] + dist[i] * torch.sin(theta[i - 1])
        # then update heading
        theta[i] = wrap_to_pi_torch(theta[i - 1] + dyaw[i])

    breakpoint()

    feats[:, 0] = torch.clamp(xy[:, 0] / pos_scale, -clamp, clamp)  # x
    feats[:, 1] = torch.clamp(xy[:, 1] / pos_scale, -clamp, clamp)  # y
    feats[:, 2] = torch.sin(theta)  # sin(theta)
    feats[:, 3] = torch.cos(theta)  # cos(theta)

    return dyaw, dist, xy, feats


if __name__ == "__main__":
    # Test with a simple trajectory
    poses = torch.tensor([[[-0.    , -0.5   ,  0.866 ,  0.    ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.    , -0.5   ,  0.866 ,  0.25  ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.    , -0.5   ,  0.866 ,  0.5   ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.    , -0.5   ,  0.866 ,  0.75  ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.    , -0.5   ,  0.866 ,  1.    ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.    , -0.5   ,  0.866 ,  1.25  ],
                            [-1.    ,  0.    , -0.    ,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  1.25  ],
                            [-0.9659, -0.1294,  0.2241,  0.    ],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  1.4915],
                            [-0.9659, -0.1294,  0.2241,  0.0647],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  1.733 ],
                            [-0.9659, -0.1294,  0.2241,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  1.733 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  1.983 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  2.233 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  2.483 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  2.733 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  2.983 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  3.233 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  3.483 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  3.733 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  3.983 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.25  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  4.233 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.2755],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  4.483 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.3216],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  4.733 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.3645],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  4.983 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.3931],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  5.233 ],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.4217],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  5.233 ],
                            [-0.9659, -0.1294,  0.2241,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.4217],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  5.4744],
                            [-0.9659, -0.1294,  0.2241,  0.1941],
                            [ 0.    , -0.866 , -0.5   ,  1.4483],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.2588, -0.483 ,  0.8365,  5.7159],
                            [-0.9659, -0.1294,  0.2241,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  5.7159],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  5.9659],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  6.2159],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  6.4659],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  6.7159],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3721],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  6.9659],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3818],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  7.2159],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.3974],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  7.4659],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.413 ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  7.7159],
                            [-1.    , -0.    ,  0.    ,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.4286],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.2588, -0.483 ,  0.8365,  7.7159],
                            [-0.9659,  0.1294, -0.2241,  0.2588],
                            [ 0.    , -0.866 , -0.5   ,  1.4286],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.2588, -0.483 ,  0.8365,  7.9574],
                            [-0.9659,  0.1294, -0.2241,  0.1941],
                            [ 0.    , -0.866 , -0.5   ,  1.4496],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.2588, -0.483 ,  0.8365,  8.1989],
                            [-0.9659,  0.1294, -0.2241,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.45  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  8.1989],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.45  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[ 0.    , -0.5   ,  0.866 ,  8.4489],
                            [-1.    , -0.    ,  0.    ,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.45  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.2588, -0.483 ,  0.8365,  8.4489],
                            [-0.9659,  0.1294, -0.2241,  0.1294],
                            [ 0.    , -0.866 , -0.5   ,  1.45  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]],

                        [[-0.2588, -0.483 ,  0.8365,  8.6904],
                            [-0.9659,  0.1294, -0.2241,  0.0647],
                            [ 0.    , -0.866 , -0.5   ,  1.45  ],
                            [ 0.    ,  0.    ,  0.    ,  1.    ]]], dtype=torch.float32)
    
    dyaw, dist, xy, feats = deltas_and_trajectory_from_poses_xy(poses)

    breakpoint()
